/*
 * Copyright (c) 2023 Huawei Device Co., Ltd.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

import { NewsData, NewsFile } from '../viewmodel/NewsData';
import Constants from '../common/constants/Constants';
import { router, promptAction } from '@kit.ArkUI';
import { preferences } from '@kit.ArkData';
import { common } from '@kit.AbilityKit';
import http from '@ohos.net.http';

// å®šä¹‰åç«¯å“åº”æ•°æ®ç±»å‹
interface BackendResponse {
  code: string;
  msg: string;
  data?: object | null;
}

/**
 * æ–°é—»åˆ—è¡¨é¡¹ç»„ä»¶
 */
@Component
export default struct NewsItem {
  newsData: NewsData = new NewsData();
  @State isFavorite: boolean = false;
  @State noteId: number = 0;
  @State showDeleteConfirm: boolean = false; // æ˜¯å¦æ˜¾ç¤ºåˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
  
  // ç”¨äºè·å–åº”ç”¨ä¸Šä¸‹æ–‡
  private context = getContext(this) as common.UIAbilityContext;
  private pref = preferences.getPreferencesSync(this.context, { name: 'favoriteNotesPrefs' });

  aboutToAppear(): void {
    // ç”Ÿæˆç¬”è®°ID
    this.noteId = this.generateNoteId(this.newsData);
    // åŠ è½½æ”¶è—çŠ¶æ€
    this.loadFavoriteStatus();
  }

  // ç”Ÿæˆç¬”è®°çš„å”¯ä¸€ID
  private generateNoteId(note: NewsData): number {
    // ä½¿ç”¨æ ‡é¢˜å’Œå†…å®¹ç”Ÿæˆä¸€ä¸ªç®€å•çš„å“ˆå¸Œå€¼ä½œä¸ºID
    const str = note.title + note.content;
    let hash = 0;
    for (let i = 0; i < str.length; i++) {
      const char = str.charCodeAt(i);
      hash = ((hash << 5) - hash) + char;
      hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
    }
    return Math.abs(hash);
  }

  // åŠ è½½æ”¶è—çŠ¶æ€
  private loadFavoriteStatus(): void {
    try {
      const favoriteList = this.pref.getSync('favorites', []) as Array<number>;
      this.isFavorite = favoriteList.includes(this.noteId);
    } catch (error) {
      console.error('åŠ è½½æ”¶è—çŠ¶æ€å¤±è´¥:', error);
      this.isFavorite = false;
    }
  }

  // åˆ‡æ¢æ”¶è—çŠ¶æ€
  private toggleFavorite(): void {
    this.isFavorite = !this.isFavorite;
    this.saveFavoriteStatus();
  }

  // ä¿å­˜æ”¶è—çŠ¶æ€
  private saveFavoriteStatus(): void {
    try {
      let favoriteList = this.pref.getSync('favorites', []) as Array<number>;
      
      if (this.isFavorite) {
        // æ·»åŠ åˆ°æ”¶è—
        if (!favoriteList.includes(this.noteId)) {
          favoriteList.push(this.noteId);
        }
      } else {
        // ä»æ”¶è—ä¸­ç§»é™¤
        favoriteList = favoriteList.filter(id => id !== this.noteId);
      }
      
      this.pref.putSync('favorites', favoriteList);
      this.pref.flushSync();
    } catch (error) {
      console.error('ä¿å­˜æ”¶è—çŠ¶æ€å¤±è´¥:', error);
    }
  }

  // åˆ é™¤ç¬”è®°
  private deleteNote(): void {
    // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    this.showDeleteConfirm = true;
  }

  // ç¡®è®¤åˆ é™¤
  private confirmDelete(): void {
    // å‘é€åˆ é™¤è¯·æ±‚åˆ°åç«¯
    this.sendDeleteRequest(this.newsData.id);
    this.showDeleteConfirm = false;
  }

  // å–æ¶ˆåˆ é™¤
  private cancelDelete(): void {
    this.showDeleteConfirm = false;
  }

  // å‘é€åˆ é™¤è¯·æ±‚åˆ°åç«¯
  private sendDeleteRequest(noteId: number): void {
    let httpRequest = http.createHttp();
    const baseUrl = "http://172.17.75.16:9588"; // åç«¯æœåŠ¡åœ°å€
    const url = `${baseUrl}/news/deleteNews/${noteId}`;
    
    console.log('å‘é€åˆ é™¤è¯·æ±‚åˆ°:', url);
    
    httpRequest.request(
      url,
      {
        method: http.RequestMethod.DELETE,
        header: { 'Content-Type': 'application/json' },
        readTimeout: 50000,
        connectTimeout: 50000
      },
      (err, data) => {
        console.log('åˆ é™¤è¯·æ±‚å›è°ƒæ‰§è¡Œ');
        console.log('é”™è¯¯ä¿¡æ¯:', JSON.stringify(err));
        console.log('å“åº”æ•°æ®:', JSON.stringify(data));
        
        if (!err) {
          console.info('åˆ é™¤è¯·æ±‚æˆåŠŸ:' + JSON.stringify(data));
          try {
            let responseData: BackendResponse = { code: '', msg: '' };
            if (typeof data.result === 'string') {
              try {
                responseData = JSON.parse(data.result) as BackendResponse;
              } catch (parseErr) {
                console.error('JSONè§£æå¤±è´¥:', parseErr);
                promptAction.showToast({ message: 'æ•°æ®è§£æå¤±è´¥' });
                return;
              }
            } else {
              responseData = data.result as BackendResponse;
            }
            
            console.log('è§£æåçš„å“åº”æ•°æ®:', JSON.stringify(responseData));
            
            if (responseData && responseData.code === 'success') {
              console.log("ç¬”è®°åˆ é™¤æˆåŠŸ");
              promptAction.showToast({ message: 'ç¬”è®°åˆ é™¤æˆåŠŸ' });
              // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ åˆ·æ–°åˆ—è¡¨çš„é€»è¾‘
            } else {
              const errorMsg = responseData ? (responseData.msg || 'æœªçŸ¥é”™è¯¯') : 'å“åº”æ•°æ®ä¸ºç©º';
              console.error('åç«¯è¿”å›é”™è¯¯:', errorMsg);
              promptAction.showToast({ message: 'åˆ é™¤å¤±è´¥: ' + errorMsg });
            }
          } catch (parseError) {
            console.error('è§£æå“åº”æ•°æ®å¤±è´¥:', parseError);
            promptAction.showToast({ message: 'æ•°æ®è§£æå¤±è´¥: ' + (parseError as Error).message });
          }
        } else {
          console.error('è¯·æ±‚å¤±è´¥:' + JSON.stringify(err));
          const errorMsg = err.message || 'æœªçŸ¥ç½‘ç»œé”™è¯¯';
          promptAction.showToast({ message: 'åˆ é™¤è¯·æ±‚å¤±è´¥: ' + errorMsg });
        }
        httpRequest.destroy();
      }
    );
  }

  build() {
    Stack() {
      Column() {
        // å›¾ç‰‡å±•ç¤ºåŒºåŸŸï¼ˆå°çº¢ä¹¦é£æ ¼ä»¥å›¾ç‰‡ä¸ºä¸»ï¼‰
        // ä¿®å¤imagesUrlæ˜¾ç¤ºé—®é¢˜ï¼Œå…¼å®¹åç«¯è¿”å›çš„ä¸åŒæ ¼å¼
        Image(Constants.SERVER + (typeof this.newsData.imagesUrl === 'string' ? this.newsData.imagesUrl : (this.newsData.imagesUrl && this.newsData.imagesUrl.length > 0 ? this.newsData.imagesUrl[0]?.url : '')))
          .objectFit(ImageFit.Cover)
          .aspectRatio(0.8) // å®½é«˜æ¯”ï¼Œä½¿å›¾ç‰‡çœ‹èµ·æ¥æ›´åƒå°çº¢ä¹¦çš„é£æ ¼
          .clip(true)
          .width('100%')
          .onClick(() => {
            // ç‚¹å‡»å›¾ç‰‡è·³è½¬åˆ°è¯¦æƒ…é¡µ
            router.pushUrl({
              url: 'pages/zonghezuoye/NoteDetailPage',
              params: this.newsData
            });
          })
        
        // æ ‡é¢˜å’Œå†…å®¹åŒºåŸŸ
        Column() {
          Row() {
            Text(this.newsData?.title)
              .fontSize($r('app.float.title_font'))
              .fontColor($r('app.color.title_color'))
              .maxLines(2)
              .lineHeight($r('app.float.title_line_height'))
              .fontFamily($r('app.string.harmony_hei_ti_medium'))
              .textOverflow({ overflow: TextOverflow.Ellipsis })
              .fontWeight(Constants.TITLE_FONT_WEIGHT)
              .layoutWeight(1)
              .onClick(() => {
                // ç‚¹å‡»æ ‡é¢˜è·³è½¬åˆ°è¯¦æƒ…é¡µ
                router.pushUrl({
                  url: 'pages/zonghezuoye/NoteDetailPage',
                  params: this.newsData
                });
              })
            
            // åˆ é™¤æŒ‰é’®ï¼ˆä»…åœ¨è¯¦æƒ…é¡µæ˜¾ç¤ºï¼‰
            Image($r("app.media.ic_fail_refresh")) // ä½¿ç”¨ç°æœ‰çš„åˆ é™¤å›¾æ ‡ï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥ä½¿ç”¨ä¸“ç”¨çš„åˆ é™¤å›¾æ ‡
              .width(20)
              .height(20)
              .margin({ left: 10 })
              .onClick(() => {
                this.deleteNote();
              })
          }
          .width('100%')
            
          Text(this.newsData?.content)
            .fontSize($r('app.float.desc_font'))
            .fontFamily($r('app.string.harmony_hei_ti'))
            .opacity(Constants.DESC_OPACITY)
            .fontColor($r('app.color.title_color'))
            .lineHeight($r('app.float.desc_line_height'))
            .width('100%')
            .maxLines(3)
            .fontWeight(Constants.DESC_FONT_WEIGHT)
            .textOverflow({ overflow: TextOverflow.Ellipsis })
            .margin({ top: $r('app.float.normal_padding') })
            .onClick(() => {
              // ç‚¹å‡»å†…å®¹è·³è½¬åˆ°è¯¦æƒ…é¡µ
              router.pushUrl({
                url: 'pages/zonghezuoye/NoteDetailPage',
                params: this.newsData
              });
            })
          
          // æ¥æºä¿¡æ¯å’Œäº’åŠ¨å…ƒç´ 
          Row() {
            Column(){
              Text(this.newsData?.source ?? '')
                .fontSize($r('app.float.source_font'))
                .fontColor($r('app.color.fontColor_text2'))
              
              Text('å‘å¸ƒè€…: ' + (this.newsData?.author ?? 'æœªçŸ¥'))
                .fontSize($r('app.float.source_font'))
                .fontColor($r('app.color.fontColor_text2'))
            }
            .layoutWeight(1)
            
            // æ·»åŠ ä¸€äº›äº’åŠ¨å…ƒç´ ï¼ˆç‚¹èµã€è¯„è®ºã€æ”¶è—ï¼‰
            Blank()
            
            Row() {
              // æ”¶è—æŒ‰é’®
              if (this.isFavorite) {
                Text('â¤')
                  .fontSize(16)
                  .margin({ right: 10 })
                  .fontColor('#ff5722')
                  .onClick(() => {
                    this.toggleFavorite();
                  })
              } else {
                Text('â™¡')
                  .fontSize(16)
                  .margin({ right: 10 })
                  .fontColor('#999')
                  .onClick(() => {
                    this.toggleFavorite();
                  })
              }
              
              Text('ğŸ’¬')
                .fontSize(16)
            }
          }
          .width('100%')
          .margin({ top: $r('app.float.normal_padding') })
        }
        .padding({
          left: $r('app.float.common_padding'),
          right: $r('app.float.common_padding'),
          bottom: $r('app.float.common_padding'),
          top: $r('app.float.normal_padding')
        })
      }
      .backgroundColor($r('app.color.white'))
      .borderRadius($r('app.float.item_border_radius'))
      .onClick(() => {
        // ç‚¹å‡»æ•´ä¸ªå¡ç‰‡è·³è½¬åˆ°è¯¦æƒ…é¡µ
        router.pushUrl({
          url: 'pages/zonghezuoye/NoteDetailPage',
          params: this.newsData
        });
      })
      .shadow({ radius: 6, color: '#1F000000', offsetX: 0, offsetY: 2 })
      
      // åˆ é™¤ç¡®è®¤å¯¹è¯æ¡†
      if (this.showDeleteConfirm) {
        Column() {
          Text('ç¡®è®¤åˆ é™¤')
            .fontSize(18)
            .fontWeight(FontWeight.Bold)
            .margin({ bottom: 10 })
          
          Text('ç¡®å®šè¦åˆ é™¤è¿™ç¯‡ç¬”è®°å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')
            .fontSize(14)
            .fontColor('#666666')
            .textAlign(TextAlign.Center)
            .margin({ bottom: 20 })
          
          Row({ space: 15 }) {
            Button('N')
              .backgroundColor('#FFFFFF')
              .border({ width: 1, color: '#CCCCCC' })
              .fontColor('#333333')
              .layoutWeight(1)
              .height(40)
              .fontSize(14)
              .onClick(() => {
                this.cancelDelete();
              })
            
            Button('Y')
              .backgroundColor('#F5222D')
              .fontColor('#FFFFFF')
              .layoutWeight(1)
              .height(40)
              .fontSize(14)
              .onClick(() => {
                this.confirmDelete();
              })
          }
          .width('100%')
        }
        .width('80%')
        .padding(20)
        .backgroundColor('#FFFFFF')
        .borderRadius(10)
        .shadow({ radius: 10, color: '#00000030', offsetX: 0, offsetY: 5 })
        .position({ x: '10%', y: '30%' })
      }
    }
  }
}